<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auto Camera Upload</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta http-equiv="Permissions-Policy" content="camera=(self)">

<style>
    body { background:#111; color:white; text-align:center; padding:20px; font-family:Arial, sans-serif; }
    video { width:90%; max-width:450px; border-radius:12px; margin-top:20px; }
    #status { margin-top:20px; font-size:18px; }
</style>
</head>

<body>

<h2>Auto Camera Capture ‚Üí Upload</h2>
<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<p id="status">Opening camera‚Ä¶</p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// ‚úÖ Your Supabase credentials
const supabase = createClient(
    "https://tizggefikijllpwgpsqy.supabase.co",
    "sb_publishable_FTRXKZXq_uCSylUM1B-LYw_zweLG2OX"
);

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const statusEl = document.getElementById("status");

// üé• Start front camera
async function startCamera() {
    try {
        statusEl.textContent = "Requesting camera‚Ä¶";

        console.log("Requesting camera with:", { video: true });

        const stream = await navigator.mediaDevices.getUserMedia({
            video: true
        });

        console.log("Camera stream:", stream);

        video.srcObject = stream;
        statusEl.textContent = "Camera started‚Ä¶";

        video.onloadedmetadata = () => {
            console.log("Metadata loaded");
            setTimeout(captureAndUpload, 1500);
        };

    } catch (err) {
        console.error("Camera error:", err);
        statusEl.innerHTML = "‚ùå Camera error:<br>" + err.name + "<br>" + err.message;
    }
}


// üì∏ Capture + Upload
async function captureAndUpload() {
    statusEl.textContent = "Capturing photo‚Ä¶";

    const ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.9));

    const filename = "photo_" + Date.now() + ".jpg";

    statusEl.textContent = "Uploading‚Ä¶";

    const { data, error } = await supabase.storage
        .from("photos")
        .upload(filename, blob);

    if (error) {
        statusEl.textContent = "‚ùå Upload failed: " + error.message;
        console.error(error);
        return;
    }

    statusEl.innerHTML = `‚úÖ Uploaded!<br>File: ${filename}<br><br>You can view it in your Supabase Storage.`;
}

startCamera();
</script>

</body>
</html>
