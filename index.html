<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auto Camera Upload</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Permissions-Policy" content="camera=(self)">
<style>
    body { background:#111; color:white; text-align:center; padding:20px; font-family:Arial; }
    video { width:90%; max-width:450px; border-radius:12px; margin-top:20px; background:#222; }
    #status { margin-top:20px; font-size:18px; }
</style>
</head>

<body>
<h2>Auto Camera Capture → Upload</h2>
<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<p id="status">Opening camera…</p>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
    "https://tizggefikijllpwgpsqy.supabase.co",
    "sb_publishable_FTRXKZXq_uCSylUM1B-LYw_zweLG2OX"
);

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const statusEl = document.getElementById("status");

// Start Camera
async function startCamera() {
    try {
        statusEl.textContent = "Requesting camera…";

        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        video.onloadedmetadata = () => {
            setTimeout(captureAndUpload, 1500);
        };
    } catch (err) {
        statusEl.innerHTML = "❌ Camera error:<br>" + err.name + "<br>" + err.message;
        console.error(err);
    }
}

// Capture + Upload
async function captureAndUpload() {
    statusEl.textContent = "Capturing…";

    const ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.9));
    const filename = "photo_" + Date.now() + ".jpg";

    statusEl.textContent = "Uploading…";

    const { data, error } = await supabase.storage
        .from("photos")
        .upload(filename, blob);

    if (error) {
        statusEl.textContent = "❌ Upload failed: " + error.message;
        return;
    }

    statusEl.innerHTML = "✅ Uploaded!<br>Saved as: " + filename;
}

startCamera();
</script>

</body>
</html>

